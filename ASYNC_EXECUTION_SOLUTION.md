# Async Execution - Final Solution (Commit 8e1e473)

**Date:** 2026-02-17
**Status:** ‚úÖ FIXED (pending deployment verification)

---

## The Real Problem

The `run_async.sh` script was calling the Python server directly with **no arguments**, causing it to enter deprecated "server mode" (listening on port 9999) instead of processing the job directly.

---

## Root Cause Discovery

### What We Tried (WRONG):

1. **Commit 9e1ec39**: Added `job-config: method-runner: jobRunner` to kbase.yml
   - Result: Still hung at "Listening on port 9999"

2. **Commit 262cee6**: Removed job-config, called bin script directly from entrypoint
   - Result: `AttributeError: 'NoneType' object has no attribute 'keys'`
   - Reason: bin script got empty arguments, server got config=None

3. **Commit 2027612**: Called run_async.sh which sets KB_DEPLOYMENT_CONFIG
   - Result: Config loaded ‚úì but still "Listening on port 9999"
   - Reason: run_async.sh called Python server with NO arguments

### The Breakthrough

Found a working reference module: **KBDatalakeApps**

**KBDatalakeApps/scripts/run_async.sh (CORRECT):**
```bash
#!/bin/bash
script_dir=$(dirname "$(readlink -f "$0")")
export KB_DEPLOYMENT_CONFIG=$script_dir/../deploy.cfg
WD=/kb/module/work
if [ -f $WD/token ]; then
    cat $WD/token | xargs sh $script_dir/../bin/run_KBDatalakeApps_async_job.sh $WD/input.json $WD/output.json
else
    echo "File $WD/token doesn't exist, aborting."
    exit 1
fi
```

**Key differences:**
1. Calls the **bin script**, not Python module directly
2. Passes **input.json and output.json** as arguments
3. Passes **token via xargs** to set KB_AUTH_TOKEN

**KBDatalakeDashboard/scripts/run_async.sh (WRONG - before fix):**
```bash
#!/bin/bash
script_dir=$(dirname "$(readlink -f "$0")")
export KB_DEPLOYMENT_CONFIG=$script_dir/../deploy.cfg
export PYTHONPATH=$script_dir/../lib:$PATH:$PYTHONPATH
export PYTHONUNBUFFERED=1
cd $script_dir/..
echo "=================================================="
echo "Starting KBDatalakeDashboard server"
echo "PYTHONPATH: $PYTHONPATH"
echo "Config: $KB_DEPLOYMENT_CONFIG"
echo "=================================================="
python -u -m KBDatalakeDashboard.KBDatalakeDashboardServer  # ‚ùå NO ARGUMENTS
```

---

## The Fix (Commit 8e1e473)

**File:** `scripts/run_async.sh`

**Updated to:**
```bash
#!/bin/bash
script_dir=$(dirname "$(readlink -f "$0")")
export KB_DEPLOYMENT_CONFIG=$script_dir/../deploy.cfg
WD=/kb/module/work
if [ -f $WD/token ]; then
    cat $WD/token | xargs sh $script_dir/../bin/run_KBDatalakeDashboard_async_job.sh $WD/input.json $WD/output.json
else
    echo "File $WD/token doesn't exist, aborting."
    exit 1
fi
```

---

## How KBase SDK Async Execution Works

### JobRunner Flow:

1. **JobRunner starts container:**
   ```bash
   docker run -v /mnt/work:/kb/module/work kbaseapps/kbdatalakedashboard:latest async
   ```

2. **Inside container, entrypoint.sh runs:**
   ```bash
   . /kb/deployment/user-env.sh                          # Source environment
   python ./scripts/prepare_deploy_cfg.py ./deploy.cfg ./work/config.properties  # Generate config
   export KB_AUTH_TOKEN=$(<./work/token)                 # Set auth token
   sh ./scripts/run_async.sh                             # Call async script
   ```

3. **run_async.sh (NOW FIXED):**
   ```bash
   export KB_DEPLOYMENT_CONFIG=$script_dir/../deploy.cfg  # Set config path
   cat $WD/token | xargs sh $script_dir/../bin/run_KBDatalakeDashboard_async_job.sh $WD/input.json $WD/output.json
   ```
   - Reads token from `/kb/module/work/token`
   - Passes it via xargs as first argument (sets KB_AUTH_TOKEN)
   - Calls bin script with input.json and output.json

4. **bin/run_KBDatalakeDashboard_async_job.sh (auto-generated by Makefile):**
   ```bash
   export KB_AUTH_TOKEN=$1  # Token from xargs
   python -u lib/KBDatalakeDashboard/KBDatalakeDashboardServer.py $2 $3
   # $2 = /kb/module/work/input.json
   # $3 = /kb/module/work/output.json
   ```

5. **KBDatalakeDashboardServer.py (auto-generated):**
   - Sees CLI arguments ‚Üí enters **direct execution mode**
   - Reads config from `KB_DEPLOYMENT_CONFIG` environment variable
   - Reads job parameters from `input.json`
   - Processes job
   - Writes results to `output.json`
   - Exits

### Key Environment Variables:

- `KB_DEPLOYMENT_CONFIG`: Path to deploy.cfg (service URLs, scratch dir)
- `KB_AUTH_TOKEN`: KBase authentication token
- `SDK_CALLBACK_URL`: Set by JobRunner for callback service

### Key Files:

- `/kb/module/work/token`: Auth token from JobRunner
- `/kb/module/work/input.json`: Job parameters (workspace_name, input_ref, etc.)
- `/kb/module/work/output.json`: Job results (report_ref, etc.)
- `/kb/module/work/config.properties`: Optional extra config (usually not present)
- `/kb/module/deploy.cfg`: Service configuration (generated from template)

---

## Expected Behavior After Fix

**Logs should show:**
```
Async execution: starting server
================================================================================
KBDatalakeDashboard __init__ called
Config keys: ['kbase-endpoint', 'job-service-url', 'workspace-url', ...]
Callback URL: http://...
Shared folder: /kb/module/work/tmp
Initializing DataFileUtil...
DataFileUtil initialized successfully
================================================================================
START: run_genome_datalake_dashboard
Params: {'workspace_name': '...', 'input_ref': '...'}
================================================================================
Validating parameters...
Parameters validated successfully
Creating output directory...
...
<actual job execution>
```

**No more:**
- ‚ùå "Listening on port 9999" followed by infinite wait
- ‚úÖ Direct job execution with full logs

---

## What We Learned

### 1. Modern KBase SDK Async Pattern:

```
entrypoint.sh (async mode)
  ‚Üì
run_async.sh
  ‚Üì (sets KB_DEPLOYMENT_CONFIG)
  ‚Üì
bin/run_*_async_job.sh
  ‚Üì (passes input.json, output.json as CLI args)
  ‚Üì
Python Server
  ‚Üì (sees CLI args ‚Üí direct execution mode)
  ‚Üì
Process job and exit
```

### 2. Why Previous Attempts Failed:

- **Commit 9e1ec39**: `job-config: method-runner: jobRunner` is not needed (and incorrect) - it's for dynamic services
- **Commit 262cee6**: Calling bin script from entrypoint with `"$@"` failed because `$@` was empty after `shift`
- **Commit 2027612**: run_async.sh set config correctly but didn't call bin script with arguments

### 3. The Makefile-Generated Bin Script:

The `make` command generates `bin/run_KBDatalakeDashboard_async_job.sh`:

```bash
# From Makefile lines 30-46:
export KB_AUTH_TOKEN=$$1
python -u lib/KBDatalakeDashboard/KBDatalakeDashboardServer.py $$2 $$3
```

This script **expects**:
- `$1` = auth token
- `$2` = input.json path
- `$3` = output.json path

### 4. The Auto-Generated Server.py:

The Python server (generated by `kb-sdk compile`) has two modes:

**Server Mode (deprecated):**
```python
# If len(sys.argv) == 1 (no CLI arguments):
cherrypy.quickstart(app, '/', config)  # Listen on port 9999
```

**Direct Execution Mode (modern):**
```python
# If len(sys.argv) >= 3 (input.json, output.json provided):
with open(sys.argv[1]) as f:
    input_params = json.load(f)
# Process job...
with open(sys.argv[2], 'w') as f:
    json.dump(output, f)
```

---

## Deployment

**Commit:** 8e1e473
**Push to:**
```bash
git push origin main
git push upstream main
```

**Expected result after KBase re-deploys:**
- ‚úÖ Job starts immediately
- ‚úÖ Full debug logs visible
- ‚úÖ Job completes or shows actual error (not silent hang)

---

## Validation Checklist

After deploying 8e1e473, verify:
- [ ] Job logs show "START: run_genome_datalake_dashboard"
- [ ] No "Listening on port 9999" message
- [ ] Job processes dashboard generation
- [ ] Job completes or fails with visible error
- [ ] Report is created in workspace

---

## Files Modified

- `scripts/run_async.sh` - Fixed to call bin script with input/output files

## Files Referenced

- `scripts/entrypoint.sh` - Entry point for Docker container
- `Makefile` - Generates bin/run_*_async_job.sh script
- `lib/KBDatalakeDashboard/KBDatalakeDashboardImpl.py` - Implementation that reads SDK_CALLBACK_URL
- `/Users/jplfaria/repos/KBDatalakeApps/scripts/run_async.sh` - Reference working implementation

---

## Success Criteria

‚úÖ **FIXED** when logs show:
1. No "Listening on port 9999" message
2. "START: run_genome_datalake_dashboard" appears immediately
3. Job processes data and completes
4. Dashboard HTML is generated
5. Report appears in workspace

üéâ **No more hanging async jobs!**
