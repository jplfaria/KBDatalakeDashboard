# Async Execution Mode Fix

**Date:** 2026-02-17
**Issue:** Server starts and listens on port 9999, but JobRunner never sends the job request
**Symptom:** Job hangs indefinitely at "Listening on port 9999"

---

## Root Cause: Deprecated Server Mode

The module was using **server mode** (deprecated), where:
1. Docker container starts with `entrypoint.sh async`
2. `run_async.sh` starts Python server in listen mode
3. Server waits for HTTP POST requests on port 9999
4. **JobRunner never sends the request** because KBase no longer supports this mode

**Evidence from logs:**
```
12:21:39am  Listening on port 9999
            ... indefinite wait, no job execution ...
```

---

## The Fix: Direct Execution Mode

**File modified:** `kbase.yml`

**Change:**
```yaml
# Use direct execution mode for async jobs (not server mode)
job-config:
    method-runner: jobRunner
```

**What this does:**
- Tells KBase Catalog to use **direct execution mode**
- JobRunner will call `bin/run_KBDatalakeDashboard_async_job.sh <job_id> <callback_url>`
- Script passes CLI arguments to Python server
- Server processes job and exits (no listening)

---

## How Direct Execution Mode Works

### Old Server Mode (BROKEN)
```bash
# JobRunner starts container
docker run <image> async

# entrypoint.sh calls run_async.sh
sh ./scripts/run_async.sh

# Server listens indefinitely
python lib/KBDatalakeDashboard/KBDatalakeDashboardServer.py
# Waits for HTTP POST... never comes ‚ùå
```

### New Direct Execution Mode (FIXED)
```bash
# JobRunner calls async job script directly
bin/run_KBDatalakeDashboard_async_job.sh <job_id> <callback_url>

# Script generated by Makefile (line 35):
python -u lib/KBDatalakeDashboard/KBDatalakeDashboardServer.py <job_id> <callback_url>

# Server sees CLI arguments, processes job directly, and exits ‚úÖ
```

---

## Expected Behavior After Fix

**Logs should show:**
```
Starting KBDatalakeDashboard server
================================================================================
KBDatalakeDashboard __init__ called
...
DataFileUtil initialized successfully
================================================================================
Processing job: <job_id>
================================================================================
START: run_genome_datalake_dashboard
Params: {'workspace_name': '...', 'input_ref': '...'}
================================================================================
Validating parameters...
Parameters validated successfully
Creating output directory...
Copying HTML directory from /kb/module/data/html...
...
<rest of execution logs>
```

**No more:**
- ‚ùå "Listening on port 9999" followed by infinite wait
- ‚úÖ Direct job execution with full logs from start to finish

---

## References

### KBase SDK Documentation
- Modern modules use `method-runner: jobRunner` in kbase.yml
- Deprecated server mode (listening on port) is no longer supported
- Direct execution mode is the standard for all async jobs

### Related Files
- `/Users/jplfaria/repos/KBDatalakeDashboard/kbase.yml` - Config file (FIXED)
- `/Users/jplfaria/repos/KBDatalakeDashboard/Makefile` - Generates bin/run_*_async_job.sh
- `/Users/jplfaria/repos/KBDatalakeDashboard/scripts/run_async.sh` - Old server mode (no longer called)
- `/Users/jplfaria/repos/KBDatalakeDashboard/lib/KBDatalakeDashboard/KBDatalakeDashboardServer.py` - Auto-generated, handles both modes

---

## Deployment

**Commit:** 9e1ec39
**Pushed to:**
- jplfaria/KBDatalakeDashboard (main)
- kbaseapps/KBDatalakeDashboard (main)

**Next steps:**
1. Re-deploy module to KBase AppDev with new commit
2. Run "Run Genome Datalake Dashboard" app
3. **Expect:** Immediate execution logs (no "Listening on port 9999")
4. **Verify:** Job completes or shows actual bottleneck (Shock upload)

---

## Why This Wasn't Caught Earlier

1. **Python buffering** was masking all logs - we couldn't see the "Listening on port 9999" message
2. After fixing unbuffered output, we discovered the server was actually starting but waiting forever
3. Modern KBase SDK modules all use direct execution mode by default
4. Older SDK versions used server mode, but it's been deprecated

**Timeline:**
- **Commit 3edfbee:** Fixed Python output buffering ‚Üí logs now visible ‚úÖ
- **Commit 9e1ec39:** Fixed async execution mode ‚Üí job will actually run ‚úÖ

---

## Validation

After deploying 9e1ec39, the app should:
- ‚úÖ Start immediately (no 30-second wait)
- ‚úÖ Show all debug logs from start of run_genome_datalake_dashboard
- ‚úÖ Process the job (might still have Shock upload slowness, but we'll see it!)
- ‚úÖ Complete or fail with visible error messages

**No more black box execution!** üéâ
